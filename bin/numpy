#!/usr/bin/env python3

"""
stdin to numpy

wnix coreutils support for multidimensional arrays
"""

import sys
import argparse
import numpy as np

parser = argparse.ArgumentParser('numpy')
parser.add_argument('-o', '--to', nargs='?', choices=['bytes', 'json', 'pickle', 'repr'], default='repr')
args = parser.parse_args()

# input: a numpy array comes from somewhere, in some format
bytes = sys.stdin.buffer.read()
try:
    array = np.frombuffer(bytes)
    assert isinstance(array, np.ndarray)
except:
    print(f"Failed to create numpy array from bytes: {bytes}", file=sys.stderr)
    sys.exit(1)

# output: a numpy array goes to somewhere, in some format
if args.to == 'repr':
    print(array)
elif args.to == 'json':
    import json
    print(json.dumps(array.tolist()))
elif args.to == 'bytes':
    sys.stdout.buffer.write(array.tobytes())
elif args.to == 'pickle':
    import pickle
    sys.stdout.buffer.write(pickle.dumps(array))
else:
    raise TypeError

